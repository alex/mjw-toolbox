#
# OS X pf config file (still including magical app firewall)
#
# This file contains the main ruleset, which gets automatically loaded
# at startup.  PF will not be automatically enabled, however.  Instead,
# each component which utilizes PF is responsible for enabling and disabling
# PF via -E and -X as documented in pfctl(8).  That will ensure that PF
# is disabled only when the last enable reference is released.
#
# Care must be taken to ensure that the main ruleset does not get flushed,
# as the nested anchors rely on the anchor point defined here. In addition,
# to the anchors loaded by this file, some system services would dynamically 
# insert anchors into the main ruleset. These anchors will be added only when
# the system service is used and would removed on termination of the service.

ext_if="{ en0, en1, en2, en3 }"
ext_ip="{ (en0), (en1), (en2), (en3) }"
iorek="69.55.65.204/32"
virt01="69.55.65.205/32"
sietchtabr="96.88.251.137/32"
otheym="96.88.251.141/32"

# http(s) outbound addresses
table <ob_http> {}

scrub in on $ext_if all fragment reassemble
scrub on $ext_if all reassemble tcp

scrub-anchor "com.apple/*"

nat-anchor "com.apple/*"

rdr-anchor "com.apple/*"

# ssh in is OK for local nets.
pass in quick on en0 route-to en0 \
  proto tcp from any \
  to (en0) \
  port ssh
pass in quick on en1 route-to en1 \
  proto tcp from any \
  to (en1) \
  port ssh

# dhcp
pass in quick on $ext_if proto {udp, tcp} from any to any port {67, 68}

dummynet-anchor "com.apple/*"

anchor "com.apple/*"

load anchor "com.apple" from "/etc/pf.anchors/com.apple"

# Put our own stuff here, so it'll match last, after apple's magic.

# Move only with the observers' saccades, rendering us invisible.
block drop in log on $ext_if all
block return out log on $ext_if all

# IKE should protect us from poison DNS.
pass out on $ext_if proto udp from $ext_ip \
  to any \
  port domain

# fucking captive portals: we may need http(s) before we can IKE up
# Place external IPs into the table by hand.
pass out on $ext_if proto tcp from <ob_http> \
  to any \
  port { http, https }

# Otheym IKE (including nat-t), L2TP, IPSEC (including nat-t)
pass out on $ext_if proto { udp, tcp } from $ext_ip \
  to $otheym \
  port { ssh, l2tp, ah-esp-encap, isakmp, ipsec-msft }
pass in on $ext_if proto { udp, tcp } from $otheym \
  to $ext_ip \
  port { l2tp, ah-esp-encap, isakmp, ipsec-msft }

# ssh to trusted hosts
pass out on $ext_if proto tcp from $ext_ip \
  to { $otheym, $sietchtabr, $iorek, $virt01 } \
  port ssh
